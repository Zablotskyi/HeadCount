<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>HeadCount</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 40px;
        }

        .tree {
            display: none;
            flex-direction: column;
            align-items: center;
        }

        .node {
            width: 180px;
            min-height: 100px;
            border: 2px solid #333;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 10px;
            cursor: pointer;
            border-radius: 8px;
            background-color: green;
            transition: background-color 0.3s;
            padding: 10px;
            text-align: center;
        }

        .subordinates {
            display: flex;
            gap: 40px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .id-label {
            font-size: 14px;
            font-weight: bold;
            color: #222;
            margin-top: 4px;
        }

        .time-label {
            font-size: 11px;
            color: #333;
            margin-top: 2px;
        }

        .disabled {
            pointer-events: none;
            opacity: 0.5;
        }

        #login-section {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #email-input {
            padding: 8px;
            font-size: 16px;
        }
    </style>
</head>
<body>
<h1>HeadCount Система</h1>

<div id="login-section">
    <h3>Вхід</h3>
    <input type="email" id="email-input" placeholder="Введіть email">
    <button onclick="login()">Увійти</button>
</div>

<div class="tree" id="tree-container">
    <h2 id="dept-name"></h2>
    <button onclick="startHeadCount()">HeadCount</button>
    <div id="manager-node"></div>
    <div class="subordinates" id="employees-container"></div>
</div>

<script>
    const departments = {
        "it": {
            name: "IT Відділ",
            manager: {
                name: "Олег",
                email: "oleh@company.com"
            },
            employees: [
                { name: "Іван", email: "ivan@company.com" },
                { name: "Олена", email: "olena@company.com" }
            ]
        },
        "hr": {
            name: "HR Відділ",
            manager: {
                name: "Марія",
                email: "maria@company.com"
            },
            employees: [
                { name: "Андрій", email: "andriy@company.com" }
            ]
        }
    };

    let currentUser = null;

    function login() {
        const email = document.getElementById('email-input').value.trim().toLowerCase();
        for (const deptKey in departments) {
            const dept = departments[deptKey];

            if (dept.manager.email === email) {
                currentUser = { ...dept.manager, role: 'manager', deptKey };
            } else {
                const emp = dept.employees.find(e => e.email === email);
                if (emp) {
                    currentUser = { ...emp, role: 'employee', deptKey };
                }
            }

            if (currentUser) break;
        }

        if (!currentUser) {
            alert('Email не знайдено.');
            return;
        }

        sessionStorage.setItem('userEmail', email);
        document.getElementById('login-section').style.display = 'none';
        buildInterface();
    }

    function buildInterface() {
        const dept = departments[currentUser.deptKey];
        document.getElementById('dept-name').textContent = dept.name;
        document.querySelector('.tree').style.display = 'flex';

        const mgrNode = document.getElementById('manager-node');
        mgrNode.innerHTML = createNodeHTML(dept.manager.name + " (Керівник)", dept.manager.email);

        const empContainer = document.getElementById('employees-container');
        empContainer.innerHTML = '';
        dept.employees.forEach(emp => {
            const node = document.createElement('div');
            node.innerHTML = createNodeHTML(emp.name, emp.email);
            empContainer.appendChild(node.firstElementChild);
        });

        loadState();
        setPermissions();
    }

    function createNodeHTML(name, email) {
        return `
        <div class="node" id="${email}" onclick="confirmPresence('${email}')">
          <div>${name}</div>
          <div class="id-label">${email}</div>
          <div class="time-label" id="time-${email}"></div>
        </div>
      `;
    }

    function getAllUserEmails() {
        const dept = departments[currentUser.deptKey];
        return [dept.manager.email, ...dept.employees.map(e => e.email)];
    }

    function setPermissions() {
        getAllUserEmails().forEach(email => {
            const el = document.getElementById(email);
            if (email !== currentUser.email) {
                el.classList.add('disabled');
                el.title = 'Недоступно для вас';
            }
        });
    }

    function loadState() {
        getAllUserEmails().forEach(email => {
            const el = document.getElementById(email);
            const state = localStorage.getItem(email);
            el.style.backgroundColor = state || 'green';

            const time = localStorage.getItem(`time-${email}`);
            const timeLabel = document.getElementById(`time-${email}`);
            if (time && timeLabel) {
                timeLabel.textContent = `Останнє підтвердження: ${time}`;
            }
        });
    }

    function startHeadCount() {
        getAllUserEmails().forEach(email => {
            const el = document.getElementById(email);
            el.style.backgroundColor = 'red';
            localStorage.setItem(email, 'red');
            localStorage.removeItem(`time-${email}`);
            const timeLabel = document.getElementById(`time-${email}`);
            if (timeLabel) timeLabel.textContent = '';
        });
    }

    function confirmPresence(email) {
        if (email !== currentUser.email) return;

        const el = document.getElementById(email);
        if (el.style.backgroundColor === 'red') {
            el.style.backgroundColor = 'green';
            localStorage.setItem(email, 'green');

            const time = new Date().toLocaleString();
            localStorage.setItem(`time-${email}`, time);

            const timeLabel = document.getElementById(`time-${email}`);
            if (timeLabel) timeLabel.textContent = `Останнє підтвердження: ${time}`;
        }
    }

    window.onload = () => {
        const savedEmail = sessionStorage.getItem('userEmail');
        if (savedEmail) {
            document.getElementById('email-input').value = savedEmail;
            login();
        }
    };
</script>
</body>
</html>
